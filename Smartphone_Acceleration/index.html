<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>G-sensor | IoTtalk</title>
    <link rel="stylesheet" type="text/css" href="css/gsensor.css">
</head>
<body>

    <main>
        <h2></h2>
        <section id="x">
            <label>X</label>
            <span></span>
        </section>
        <section id="y">
            <label>Y</label>
            <span></span>
        </section>
        <section id="z">
            <label>Z</label>
            <span></span>
        </section>
        <section>
            <button id="adjust">Adjust</button>
            <button id="reset">Reset</button>
        </section>
    </main>


    <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="js/iottalk-api.js"></script>
    <script type="text/javascript">
        window.mac = Math.random().toString().slice(2);
        window.d_name = null;

        var interval = 250;
        var accur = 10;
        var eps = 0.001;

        var gsensor = {};
        var offset = { ax: 0, ay: 0, az: 0 };
        var output = {};
        var xDom = $('#x > span');
        var yDom = $('#y > span');
        var zDom = $('#z > span');

        window.ondevicemotion = function(event) {
            var ax = event.accelerationIncludingGravity.x || 0;  
            var ay = event.accelerationIncludingGravity.y || 0;
            var az = event.accelerationIncludingGravity.z || 0;

            gsensor.ax = Math.round(ax*accur) / accur;
            gsensor.ay = Math.round(ay*accur) / accur;
            gsensor.az = Math.round(az*accur) / accur;

            output.ax = Math.round((gsensor.ax+offset.ax)*accur) / accur;
            output.ay = Math.round((gsensor.ay+offset.ay)*accur) / accur;
            output.az = Math.round((gsensor.az+offset.az)*accur) / accur;
        }

        $('#adjust').click(function() {
            offset.ax = -gsensor.ax;
            offset.ay = -gsensor.ay;
            offset.az = -gsensor.az;
        });

        $('#reset').click(function() {
            offset.ax = 0;
            offset.ay = 0;
            offset.az = 0;
        });


        // Dom updater
        function domUpdater() {
            xDom.text(output.ax);
            yDom.text(output.ay);
            zDom.text(output.az);
            requestAnimationFrame(domUpdater);
        }
        requestAnimationFrame(domUpdater);


        // IoTtalk updater
        function iotUpdater() {
            if( window.d_name )
                IoTtalk.update(mac, 'Acceleration', [output.ax, output.ay, output.az]);
            setTimeout(iotUpdater, interval);
        }
        setTimeout(iotUpdater, interval);


        // Register
        IoTtalk.register(mac, {
            'dm_name': 'Smartphone',
            'is_sim': false,
            'df_list': ['Acceleration'],
        }, function(ret) {
            console.log(ret);
            ret = JSON.parse(ret);
            window.d_name = ret.d_name;
            $('main > h2').text(ret.d_name);
        });


        // Detach when browser close
        function detach() {
            window.d_name = null;
            IoTtalk.detach(mac);
        }
        window.onunload = detach;
        window.onbeforeunload = detach;
        window.onclose = detach;
        window.onpagehide = detach;

    </script>

</body>
</html>
